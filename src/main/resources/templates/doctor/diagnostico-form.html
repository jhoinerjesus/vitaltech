<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{doctor/layout-doctor :: head('Doctor - Crear Diagnóstico')}"></head>
<body>

<!-- Sidebar -->
<div th:replace="~{doctor/layout-doctor :: sidebar}"></div>

<!-- Main Content -->
<div class="main-content">
    
    <!-- Top Bar -->
    <div th:replace="~{doctor/layout-doctor :: topbar}" th:with="pageTitle='Crear Diagnóstico'"></div>
    
    <div class="row animate-fade-in">
        <!-- Formulario -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-file-medical-fill"></i> Registro de Diagnóstico
                    </h5>
                </div>
                <div class="card-body p-4">
                    
                    <form th:action="@{/doctor/diagnostico/guardar}" th:object="${diagnostico}" method="post">
                        
                        <!-- Hidden fields -->
                        <input type="hidden" th:field="*{citaId}">
                        <input type="hidden" th:field="*{pacienteId}">
                        <input type="hidden" th:field="*{doctorId}">
                        
                        <!-- Diagnóstico Principal -->
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="bi bi-clipboard2-pulse"></i> Diagnóstico
                        </h6>
                        
                        <div class="mb-4">
                            <label for="diagnostico" class="form-label">Diagnóstico Principal *</label>
                            <textarea class="form-control" id="diagnostico" th:field="*{diagnostico}" 
                                      rows="3" required placeholder="Describa el diagnóstico principal..."></textarea>
                        </div>
                        
                        <!-- Síntomas -->
                        <div class="mb-4">
                            <label for="sintomas" class="form-label">Síntomas Presentados</label>
                            <textarea class="form-control" id="sintomas" th:field="*{sintomas}" 
                                      rows="3" placeholder="Describa los síntomas que presenta el paciente..."></textarea>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Signos Vitales -->
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="bi bi-heart-pulse"></i> Signos Vitales
                        </h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="presionArterial" class="form-label">Presión Arterial</label>
                                <input type="text" class="form-control" id="presionArterial" 
                                       th:field="*{presionArterial}" placeholder="Ej: 120/80">
                            </div>
                            <div class="col-md-6">
                                <label for="temperatura" class="form-label">Temperatura (°C)</label>
                                <input type="number" step="0.1" class="form-control" id="temperatura" 
                                       th:field="*{temperatura}" placeholder="Ej: 36.5">
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="frecuenciaCardiaca" class="form-label">Frecuencia Cardíaca (lpm)</label>
                                <input type="number" class="form-control" id="frecuenciaCardiaca" 
                                       th:field="*{frecuenciaCardiaca}" placeholder="Ej: 72">
                            </div>
                            <div class="col-md-4">
                                <label for="peso" class="form-label">Peso (kg)</label>
                                <input type="number" step="0.1" class="form-control" id="peso" 
                                       th:field="*{peso}" placeholder="Ej: 70.5">
                            </div>
                            <div class="col-md-4">
                                <label for="altura" class="form-label">Altura (m)</label>
                                <input type="number" step="0.01" class="form-control" id="altura" 
                                       th:field="*{altura}" placeholder="Ej: 1.75">
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Tratamiento -->
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="bi bi-capsule"></i> Tratamiento y Recomendaciones
                        </h6>
                        
                        <div class="mb-4">
                            <label for="tratamiento" class="form-label">Tratamiento Indicado</label>
                            <textarea class="form-control" id="tratamiento" th:field="*{tratamiento}" 
                                      rows="3" placeholder="Describa el tratamiento a seguir..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="medicamentos" class="form-label">Medicamentos (separados por coma)</label>
                            <input type="text" class="form-control" id="medicamentos-input" 
                                   placeholder="Ej: Paracetamol 500mg, Ibuprofeno 400mg">
                            <input type="hidden" th:field="*{medicamentos}">
                            <small class="text-muted">Ingrese los medicamentos separados por comas</small>
                        </div>
                        
                        <div class="mb-4">
                            <label for="recomendaciones" class="form-label">Recomendaciones</label>
                            <textarea class="form-control" id="recomendaciones" th:field="*{recomendaciones}" 
                                      rows="3" placeholder="Recomendaciones para el paciente..."></textarea>
                        </div>
                        
                        <!-- Exámenes -->
                        <div class="mb-4">
                            <label for="examenesOrdenados" class="form-label">Exámenes Ordenados (separados por coma)</label>
                            <input type="text" class="form-control" id="examenes-input" 
                                   placeholder="Ej: Hemograma completo, Radiografía de tórax">
                            <input type="hidden" th:field="*{examenesOrdenados}">
                            <small class="text-muted">Ingrese los exámenes separados por comas</small>
                        </div>
                        
                        <!-- Observaciones -->
                        <div class="mb-4">
                            <label for="observaciones" class="form-label">Observaciones Adicionales</label>
                            <textarea class="form-control" id="observaciones" th:field="*{observaciones}" 
                                      rows="2" placeholder="Cualquier observación adicional..."></textarea>
                        </div>
                        
                        <!-- Botones -->
                        <div class="d-flex justify-content-between">
                            <a th:href="@{/doctor/citas/{id}(id=${cita.id})}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-doctor">
                                <i class="bi bi-save"></i> Guardar Diagnóstico
                            </button>
                        </div>
                    </form>
                    
                </div>
            </div>
        </div>
        
        <!-- Información de la Cita y Paciente -->
        <div class="col-lg-4">
            <!-- Cita -->
            <div class="card mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-calendar-check text-primary"></i> Información de la Cita
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <i class="bi bi-calendar3"></i> 
                        <span th:text="${#temporals.format(cita.horario.fecha, 'dd/MM/yyyy')}"></span>
                    </p>
                    <p class="mb-2">
                        <i class="bi bi-clock"></i>
                        <span th:text="${#temporals.format(cita.horario.horaInicio, 'HH:mm')}"></span>
                        - 
                        <span th:text="${#temporals.format(cita.horario.horaFin, 'HH:mm')}"></span>
                    </p>
                    <p class="mb-0" th:if="${cita.motivoConsulta}">
                        <strong>Motivo:</strong><br>
                        <span th:text="${cita.motivoConsulta}"></span>
                    </p>
                </div>
            </div>
            
            <!-- Paciente -->
            <div class="card" th:if="${paciente != null}">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-person-fill text-primary"></i> Paciente
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="avatar-circle-large bg-primary text-white mx-auto mb-2">
                            <i class="bi bi-person-fill fs-1"></i>
                        </div>
                        <h6 class="fw-bold" th:text="${paciente.nombreCompleto}"></h6>
                    </div>
                    
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <strong>Documento:</strong><br>
                            <span th:text="${paciente.numeroDocumento}"></span>
                        </li>
                        <li class="mb-2">
                            <strong>Edad:</strong> <span th:text="${paciente.edad} + ' años'"></span>
                        </li>
                        <li class="mb-2" th:if="${paciente.informacionMedica?.tipoSangre}">
                            <strong>Tipo de Sangre:</strong> 
                            <span th:text="${paciente.informacionMedica.tipoSangre}"></span>
                        </li>
                        <li th:if="${paciente.informacionMedica?.alergias != null and !paciente.informacionMedica.alergias.empty}">
                            <strong class="text-danger">Alergias:</strong><br>
                            <span class="text-danger" th:each="alergia, iterStat : ${paciente.informacionMedica.alergias}">
                                <span th:text="${alergia}"></span>
                                <span th:if="${!iterStat.last}">, </span>
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
</div>

<style>
    .avatar-circle-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<!-- Scripts -->
<div th:replace="~{doctor/layout-doctor :: scripts}"></div>

<script>
    // Convertir campos de texto separados por comas a listas
    document.addEventListener('DOMContentLoaded', function() {
        // Medicamentos
        const medicamentosInput = document.getElementById('medicamentos-input');
        const medicamentosHidden = document.querySelector('input[name="medicamentos"]');
        
        medicamentosInput.addEventListener('change', function() {
            const medicamentos = this.value.split(',').map(m => m.trim()).filter(m => m !== '');
            medicamentosHidden.value = JSON.stringify(medicamentos);
        });
        
        // Exámenes
        const examenesInput = document.getElementById('examenes-input');
        const examenesHidden = document.querySelector('input[name="examenesOrdenados"]');
        
        examenesInput.addEventListener('change', function() {
            const examenes = this.value.split(',').map(e => e.trim()).filter(e => e !== '');
            examenesHidden.value = JSON.stringify(examenes);
        });
        
        // Validar formulario antes de enviar
        document.querySelector('form').addEventListener('submit', function(e) {
            // Actualizar campos ocultos
            medicamentosInput.dispatchEvent(new Event('change'));
            examenesInput.dispatchEvent(new Event('change'));
        });
    });
</script>

</body>
</html>